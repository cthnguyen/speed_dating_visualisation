var dico_from = {0: "UNCC",
 1: "Minnesota",
 2: "New Jersey",
 3: "Las Vegas, Nevada",
 4: "Shanghai, China",
 5: "New York Area/ New Jersey",
 6: "uruguay",
 7: "UK/Turkey",
 8: "NYC",
 9: "Born in Montana, raised in South Jersey (nr. Philadelphia)",
 10: "San Francisco/LA",
 11: "Detroit suburbs",
 12: "San Diego",
 13: "SOUTH KOREA",
 14: "Greece/Germany",
 15: "nashville, TN",
 16: "Bangladesh",
 17: "Westchester, new York",
 18: "London, England",
 19: "California and New York",
 20: "california",
 21: "Colombia",
 22: "Portland, Oregon",
 23: "way too little space here. world citizen.",
 24: "Washington State",
 25: "Northern New Jersey",
 26: "Toronto, London, India",
 27: "Chicago",
 28: "India, Holland",
 29: "Southern California",
 30: "Miami",
 31: "Houston",
 32: "Colorado",
 33: "Sweden",
 34: "Staten Island",
 35: "colorado",
 36: "New York City",
 37: "India/Venezuela",
 38: "Europe",
 39: "Italy",
 40: "los angeles",
 41: "Massachusetts",
 42: "Korea",
 43: "South Orange, New Jersey",
 44: "Cleveland",
 45: "Georgia, USA",
 46: "taiwan",
 47: "Northern California",
 48: "Hong Kong",
 49: "working",
 50: "Wash DC (4 yrs)",
 51: "Hawaii and Los Angeles",
 52: "Mexico",
 53: "lOS aNGELES",
 54: "poland",
 55: "Detroit, Michigan, USA",
 56: "alabama",
 57: "Ann Arbor, MI",
 58: "Katonah, NY (more recently, Boston)",
 59: "Philadelphia, PA",
 60: "ottawa, canada",
 61: "Queens",
 62: "Rochester, NY",
 63: "Lexington, MA",
 64: "London & New York",
 65: "P. R. China",
 66: "Australia",
 67: "Maryland",
 68: "Virginia",
 69: "Michigan",
 70: "Los Angeles, CA",
 71: "Minneapolis, MN",
 72: "TN",
 73: "Born in Iran",
 74: "Milwaukee, Wisconsin",
 75: "NYC, San Francisco",
 76: "China",
 77: "Palo Alto, CA",
 78: "Florida",
 79: "NJ",
 80: "Brooklyn, NY",
 81: "Washington DC Metro Region",
 82: "japan",
 83: "Brazil",
 84: "Wisconsin",
 85: "New Mexico",
 86: "India",
 87: "Woburn, MA",
 88: "Baltimore",
 89: "new york",
 90: "New York",
 91: "czech republic",
 92: "NYC-6 yrs. Grew up in Nebraska",
 93: "Long Island, NY",
 94: "Russia/Germany",
 95: "Colombia, South America",
 96: "Panama",
 97: "Cherry Hill, NJ",
 98: "Philadelphia",
 99: "Malaysia, then Massachusetts",
 100: "North Carolina",
 101: "france",
 102: "Pittsburgh, PA",
 103: "BEIJING, CHINA",
 104: "PA",
 105: "new york city",
 106: "Indonesia",
 107: "Dallas, Texas",
 108: "DC",
 109: "Texas",
 110: "Greece",
 111: "Azerbaijan",
 112: "CALIFORNIA",
 113: "Los Angeles",
 114: "Long Island",
 115: "Belgium",
 116: "Ann Arbor",
 117: "Singapore",
 118: "Chile",
 119: "Uzbekistan",
 120: "Berkeley, CA",
 121: "State College, PA",
 122: "New Delhi, India",
 123: "Florida and Virginia",
 124: "International Student",
 125: "Austin, TX",
 126: "Tokyo and Texas",
 127: "Tokyo, Japan",
 128: "Persia",
 129: "Palm Springs, California",
 130: "Washington DC",
 131: "San Francisco, CA",
 132: "Kansas",
 133: "California",
 134: "Cambridge, MA",
 135: "Taipei, Taiwan",
 136: "Washington, D.C.",
 137: "Arizona",
 138: "Russia",
 139: "Nebraska",
 140: "philippines",
 141: "Costa Rica",
 142: "sofia, bg",
 143: "Israel",
 144: "Brandeis University",
 145: "CT, FL, TN",
 146: "Minneapolis",
 147: "Iceland",
 148: "Bulgaria",
 149: "Indiana",
 150: "Canada",
 151: "Paris",
 152: "Toronto",
 153: "San Francisco Bay Area",
 154: "Atlanta, GA",
 155: "Boston, MA",
 156: "brooklyn, ny",
 157: "Cincinnati, OH",
 158: "Silver Spring, MD",
 159: "Pennsylvania",
 160: "Torrance, CA",
 161: "Taiwan",
 162: "California (West Coast)",
 163: "brooklyn ny",
 164: "Cameroon",
 165: "San Francisco",
 166: "Bowdoin College",
 167: "HKG",
 168: "south carolina",
 169: "Burlington, Vermont",
 170: "Switzerland",
 171: "spain",
 172: "94115",
 173: "Milan, Italy",
 174: "Oregon",
 175: "SIngapore",
 176: "Cincinnati, Ohio",
 177: "England",
 178: "Boston",
 179: "Bogota, Colombia",
 180: "nyc",
 181: "atlanta, ga",
 182: "Japan",
 183: "Cambridge, Massachusetts",
 184: "Philippines",
 185: "Upstate New York",
 186: "Brooklyn",
 187: "Midwest USA",
 188: "Genova, Italy",
 189: "New York, NY",
 190: "Seattle",
 191: "Albuquerque, NM",
 192: "Ohio",
 193: "Buffalo, NY",
 194: "Detroit",
 195: "Pittsburgh",
 196: "Portland, OR",
 197: "Washington, DC",
 198: "Berkeley",
 199: "London, UK",
 200: "Germany",
 201: "Milan - Italy",
 202: "J.P. Morgan",
 203: "Siberia",
 204: "Manila, Philippines",
 205: "Manhattan",
 206: "Kansas City, Missouri",
 207: "Spain",
 208: "India and NJ",
 209: "Atlanta",
 210: "Yugoslavia",
 211: "California, New Jersey",
 212: "Puerto Rico",
 213: "Hastings-on-Hudson, NY",
 214: "Westchester County, N.Y.",
 215: "Salt Lake City",
 216: "Toronto, Canada",
 217: "New Hope, PA",
 218: "Connecticut",
 219: "France",
 220: "UK",
 221: "Northern Virginia",
 222: "Palo Alto, California",
 223: "Erie, PA",
 224: "Budapest",
 225: "Pougkeepsie NY",
 226: "Bronx Science",
 227: "Tuscaloosa, Alabama",
 228: "Bombay, India",
 229: "MD",
 230: "Westchester, NY"};
var dico_race = {1 : "Black/African American",
			 2 : "European/Caucasian-American",
			 3 : "Latino/Hispanic American",
			 4 : "Asian/Pacific Islander/Asian-American",
			 5 : "Native American",
			 6 : "Other"};
var dico_career = {1 : "Lawyer",
			2: "Academic/Research",
			3: "Psychologist",
			4: "Doctor/Medicine",
			5: "Engineer",
			6: "Creative Arts/Entertainment",
			7: "Banking/Consulting/Finance/Marketing/Business/CEO/Entrepreneur/Admin",
			8: "Real Estate",
			9: "International/Humanitarian Affairs",
			10: "Undecided",
			11:"Social Work",
			12:"Speech Pathology",
			13:"Politics",
			14:"Pro sports/Athletics",
			15:"Other",
			16:"Journalism",
			17:"Architecture"};
var dico_goal = {1 : "Seemed like a fun night out",
			 2 : "To meet new people",
			 3 : "To get a date",
			 4 : "Looking for a serious relationship",
			 5 : "To say I did it",
			 6 : "Other"};
var dico_field = {1: "Law",
			2: "Math",
			3: "Social Science, Psychologist",
			4: "Medical Science, Pharmaceuticals, and Bio Tech",
			5: "Engineering",
			6: "English/Creative Writing/ Journalism",
			7: "History/Religion/Philosophy",
			8: "Business/Econ/Finance",
			9: "Education, Academia",
			10: "Biological Sciences/Chemistry/Physics",
			11: "Social Work",
			12: "Undergrad/undecided",
			13:"Political Science/International Affairs",
			14:"Film",
			15:"Fine Arts/Arts Administration",
			16:"Languages",
			17:"Architecture",
			18:"Other"};
var dico_global = {"race": dico_race, "goal": dico_goal, "field_cd": dico_field, "from": dico_from, "career_c": dico_career};
var dico_name = {"Race": "race", "From": "from", "Field": "field_cd", "Career": "career_c", "Goal": "goal"}

// set the dimensions and margins of the graph
var margin = {top: 10, right: 10, bottom: 10, left: 10},
	width = 600 - margin.left - margin.right,
	height = 650 - margin.top - margin.bottom;


// append the svg object to the body of the page
var svg_sankey = d3.select("#sankey").append("svg")
	.attr("width", width + margin.left + margin.right)
	.attr("height", height + margin.top + margin.bottom)
  .append("g")
	.attr("transform",
		  "translate(" + margin.left + "," + margin.top + ")");

// Text Scale
var textScale = d3.scaleLinear()
	.range([90, 110]);

// Set the sankey diagram properties
var sankey = d3.sankey()
	.nodeWidth(25)
	.nodePadding(1)
	.size([width, height]);
	
// Define the div for the tooltip
var div_link = d3.select("body").append("div")	
	.attr("class", "tooltip_link")				
	.style("opacity", 0);
var div_node = d3.select("body").append("div")	
	.attr("class", "tooltip_node")				
	.style("opacity", 0);

// For First Construction
var e_H = document.getElementById("category_H");
var e_F = document.getElementById("category_F");
var selectedCategory_H = e_H.options[e_H.selectedIndex].text;
var selectedCategory_F = e_F.options[e_F.selectedIndex].text;	
	
// Construct Sankey
constructSankey (dico_name[selectedCategory_H], dico_name[selectedCategory_F])
	
// Modify Sankey
$( "select" )
  .change(function () {
	var selectedCategory_H = e_H.options[e_H.selectedIndex].text;
	var selectedCategory_F = e_F.options[e_F.selectedIndex].text;
	d3.selectAll(".link").remove();
	d3.selectAll(".node").remove();
	constructSankey(dico_name[selectedCategory_H], dico_name[selectedCategory_F]);
   });
	
// Function to construct Sankey
function constructSankey (attribute_H, attribute_F){
	// Variables initialization
	var prevCol = "";
	var prevColR = "";
	var click_H = "";
	var click_F = "";
	var color_click = "rgb(95, 101, 112)";
	var color_link = "#fff"
	var node_click_H = "";
	var node_click_F = "";
	var node_selected;
	var graph = {"nodes" : [], "links" : []};
	
	// Load data and process
	d3.csv("data/df_sankey.csv", function(error, data){
		
		// INITIALIZE THE NODES
		var category_H = attribute_H
		var category_F = attribute_F
		var dico_code_to_node_H = {};
		var dico_code_to_node_F = {};
		var dico_code_to_name_H = dico_global[category_H];
		var dico_code_to_name_F = dico_global[category_F];
		// var data_nodes = [];
		var offset = 0;
		var data_groupby_H = d3.nest()
		  .key(function(d) { return d[category_H+"_H"]; })
		  .rollup(function(v) { return v.length; })
		  .entries(data);
		var data_groupby_F = d3.nest()
		  .key(function(d) { return d[category_F+"_F"]; })
		  .rollup(function(v) { return v.length; })
		  .entries(data);
		// CREATE NODES FOR MEN
		data_groupby_H.forEach(function(item, index, array) {
		  dico_code_to_node_H[item.key] = index;
		  graph.nodes.push({"node":+index, "name":dico_code_to_name_H[item.key]})
		  offset = index+1;
		});
		// CREATE NODES FOR WOMEN
		data_groupby_F.forEach(function(item, index, array) {
		  dico_code_to_node_F[item.key] = index + offset;
		  graph.nodes.push({"node":+index+offset, "name":dico_code_to_name_F[item.key]})
		});
		// LINKS
		var source = "";
		var data_groupby = d3.nest()
		  .key(function(d) { return d[category_H+"_H"]; })
		  .key(function(d) { return d[category_F+"_F"]; })
		  .rollup(function(v) { return v.length; })
		  .entries(data);
		data_groupby.forEach(function(item, index, array) {
			source = item.key 
			item.values.forEach(function(item, index, array) {
			  graph.links.push({"source":+dico_code_to_node_H[source], "target":+dico_code_to_node_F[item.key], "value": +item.value})
			});
		});
		// Constructs a new Sankey generator with the default settings.
		sankey
		  .nodes(graph.nodes)
		  .links(graph.links)
		  .layout(0);
		
		// add in the links
		  var link = svg_sankey.append("g")
			.selectAll(".link")
			.data(graph.links)
			.enter()
			.append("path")
			  .attr("class", "link")
			  .attr("d", sankey.link() )
			  .style("stroke-width", function(d) { return Math.max(1, d.dy); })
			  .sort(function(a, b) { return b.dy - a.dy; })
			  .on("mouseover", function(d) {
				if ((d.source.node==node_click_H && click_H==1)||(d.target.node==node_click_F && click_F==1) ) {
					div_link.transition()		
						.duration(200)
						.style("opacity", .9);		
					div_link.html(Math.round(d.value/d.source.value*100) + "% of the men in the <strong>"  +  d.source.name + "</strong> Category matched with " + Math.round(d.value/d.target.value*100) + "% of the women in the <strong>"  +  d.target.name + "</strong> Category.")	// define text of the tooltip
						.style("left", (d3.event.pageX) + "px")		
						.style("top", (d3.event.pageY - 28) + "px")
				} else if (node_click_F=="" &&  node_click_H=="" ) {
					div_link.transition()
						.duration(200)
						.style("opacity", .9);		
					div_link.html(Math.round(d.value/d.source.value*100) + "% of the men in the <strong>"  +  d.source.name + "</strong> Category matched with " + Math.round(d.value/d.target.value*100) + "% of the women in the <strong>"  +  d.target.name + "</strong> Category.")	// define text of the tooltip
						.style("left", (d3.event.pageX) + "px")		
						.style("top", (d3.event.pageY - 28) + "px")
				}
			  })
			  .on("mouseout", function(d) {		
				div_link.transition()		
					.duration(500)
					.style("opacity", 0)
			   });
		// add in the nodes
	  var node = svg_sankey.append("g")
		.selectAll(".node")
		.data(graph.nodes.sort(function (a,b) {return d3.ascending(a.value, b.value); }))
		.enter().append("g")
		  .attr("class", "node")
		  .attr("transform", function(d) { return "translate(" + d.x + "," + d.y + ")"; });

	  // add the rectangles for the nodes
	  node
		.append("rect")	
		  .attr("height", function(d) { return d.dy; })
		  .attr("width", sankey.nodeWidth())
		  .attr("rx", 4)
		  .attr("ry", 4)
		  .attr("id", function(d){ return "rect_"+d.node; })
		  .style("fill", checkPositionAndColorize) // Color
		  .on("click", function(d, i) {
				node_selected = d.node;
				if (click_H == 0 && d.x==0) {
					// Change state value
					click_H = 1;
					node_click_H = d.node;
					// Reset Colors
					prevCol = ""
					prevColR = ""
					d3.selectAll("rect").style("fill", checkPositionAndColorize)
					// Change color
					d3.select(this).style("fill", color_click)
					// Show only this node links
					d3.selectAll(".link").style("stroke-opacity", 0.0).style("stroke", color_link)
					d3.selectAll(".link").filter(function(d) { return d.source.node == node_click_H}).style("stroke", color_link).style("stroke-opacity", 0.8)
					if (click_F == 1) {
						d3.select("#rect_"+node_click_F).style("fill", color_click)
						d3.selectAll(".link").filter(function(d) { return d.target.node == node_click_F}).style("stroke-opacity", 0.8).style("stroke", color_link);
					}	
				} else if (click_H == 1 && d.x==0 ) {
					if (d3.select(this).style("fill") == color_click){
						// Change state value
						click_H = 0;
						node_click_H = "";
						// Reset Colors
						prevCol = ""
						prevColR = ""
						d3.selectAll("rect").style("fill", checkPositionAndColorize)
						// Show all nodes
						if (click_F == 0) {
							d3.selectAll(".link").style("stroke-opacity", 0.5).style("stroke", color_link);
						} else {
							d3.select("#rect_"+node_click_F).style("fill", color_click)
							d3.selectAll(".link").style("stroke-opacity", 0.0).style("stroke", color_link);
							d3.selectAll(".link").filter(function(d) { return d.target.node == node_click_F }).style("stroke-opacity", 0.8).style("stroke", color_link);
						}
					} else {
						// Change state value
						node_click_H = d.node;
						// Reset Colors
						prevCol = ""
						prevColR = ""
						d3.selectAll("rect").style("fill", checkPositionAndColorize)
						// Set color
						d3.select(this).style("fill", color_click)
						// Show this node
						d3.selectAll(".link").style("stroke-opacity", 0.0).style("stroke", color_link);
						d3.selectAll(".link").filter(function(d) { return d.source.node == node_click_H}).style("stroke", color_link).style("stroke-opacity", 0.8)
						if (click_F == 1) {
							d3.select("#rect_"+node_click_F).style("fill", color_click)
							d3.selectAll(".link").filter(function(d) { return d.target.node == node_click_F }).style("stroke-opacity", 0.8).style("stroke", color_link);
						}
					}
				} else if (click_F == 0 && d.x!=0) {
					// Change state value
					click_F = 1;
					node_click_F = d.node;
					// Reset Colors
					prevCol = ""
					prevColR = ""
					d3.selectAll("rect").style("fill", checkPositionAndColorize)
					// Set color
					d3.select(this).style("fill", color_click)
					// Show only this node links
					d3.selectAll(".link").style("stroke", color_link).style("stroke-opacity", 0.0)
					d3.selectAll(".link").filter(function(d) { return d.target.node == node_click_F}).style("stroke", color_link).style("stroke-opacity", 0.8)
					if (click_H == 1) {
						d3.select("#rect_"+node_click_H).style("fill", color_click)
						d3.selectAll(".link").filter(function(d) { return d.source.node == node_click_H}).style("stroke-opacity", 0.8).style("stroke", color_link);
					}
				} else if (click_F == 1 && d.x!=0) {
					if (d3.select(this).style("fill") == color_click){
						// Change state value
						click_F = 0;
						node_click_F = "";
						// Reset Colors
						prevCol = ""
						prevColR = ""
						d3.selectAll("rect").style("fill", checkPositionAndColorize)
						// Show all nodes
						if (click_H == 0) {
							d3.selectAll(".link").style("stroke-opacity", 0.5).style("stroke", color_link);
						} else {
							d3.select("#rect_"+node_click_H).style("fill", color_click)
							d3.selectAll(".link").style("stroke-opacity", 0.0).style("stroke", color_link);
							d3.selectAll(".link").filter(function(d) { return d.source.node == node_click_H }).style("stroke-opacity", 0.8).style("stroke", color_link);
						}
					} else {
						// Change state value
						node_click_F = d.node;
						// Reset Colors
						prevCol = ""
						prevColR = ""
						d3.selectAll("rect").style("fill", checkPositionAndColorize)
						// Set color
						d3.select(this).style("fill", color_click)
						// Show this node links
						d3.selectAll(".link").style("stroke-opacity", 0.0).style("stroke", color_link);
						d3.selectAll(".link").filter(function(d) { return d.target.node == node_click_F}).style("stroke", color_link).style("stroke-opacity", 0.8)
						if (click_H == 1) {
							d3.select("#rect_"+node_click_H).style("fill", color_click)
							d3.selectAll(".link").filter(function(d) { return d.source.node == node_click_H }).style("stroke-opacity", 0.8).style("stroke", color_link);
						}
					}
				}
			})		
		   .on("mouseover", function(d) {
				div_node.transition()		
					.duration(200)		
					.style("opacity", .9)	
				div_node.html("There are <strong>" + d.value +  "</strong> persons that have matched in the category '<strong>" + d.name + "</strong>'")	// define text of the tooltip
					.style("left", (d3.event.pageX) + "px")		
					.style("top", (d3.event.pageY - 28) + "px")
			})
		   .on("mouseout", function(d) {		
				div_node.transition()		
					.duration(500)
					.style("opacity", 0)
			});

	  // add in the title for the nodes
		textScale.domain(d3.extent(graph.nodes, function(d){return d.value;}));
		node
		  .append("text")
			.attr("x", -6)
			.attr("y", function(d) { return d.dy / 2; })
			.attr("dy", ".35em")
			.attr("text-anchor", "end")
			.attr("transform", null)
			.text(function(d) { return d.name; })
			.style("font-size", function(){ return textSize = textScale(this.__data__.value).toString() + "%"; })
			.style("opacity", function(){ 
			  if(this.__data__.x > 20 && this.__data__.value > 20){
				return 1;
			  }
			  else if(this.__data__.x < 20 && this.__data__.value > 20){
				return 1;
			  }
			  else return 0;
			})
		  .filter(function(d) { return d.x < width / 2; })
			.attr("x", 6 + sankey.nodeWidth())
			.attr("text-anchor", "start");

		// Color the rectangles
		function checkPositionAndColorize(obj){
			if(obj.x == 0 && prevCol == "") {
				prevCol = "#7aa5fa";
				return "#7aa5fa";
			  }
			  else if(obj.x == 0 && prevCol == "#7aa5fa"){
				prevCol = "#b4d5f9";
				return "#b4d5f9";
			  }
			  else if(obj.x == 0 && prevCol == "#b4d5f9"){
				prevCol = "#7aa5fa";
				return "#7aa5fa";
			  }
			  else if(obj.x !== 0 && prevColR == "") {
				prevColR = "#fa7aaf"; 
				return "#fa7aaf";
			  }
			  else if(obj.x !== 0 && prevColR == "#fa7aaf"){
				prevColR = "#fdc9fa";
				return "#fdc9fa";
			  }
			  else if(obj.x !== 0 && prevColR == "#fdc9fa"){
				prevColR = "#fa7aaf";
				return "#fa7aaf";
			  }
		}
	});
}


//====================================================== RADAR CHART ===============================
var margin_radar = {top: 20, right: 20, bottom: 20, left: 20},
  width_radar = 400,
  height_radar = 400;	

var color = d3.scaleOrdinal().range(["#EDC951","#CC333F","#00A0B0"]);

var radarChartOptions = {
  w: width_radar,
  h: height_radar,
  margin: margin_radar,
  maxValue: 0.5,
  levels: 5,
  roundStrokes: true,
  color: color
};


d3.json("data/race_race.json", function(data_radar) {
	var radar_keys = Object.keys(data_radar)
	var radar1 = data_radar[radar_keys[0]]
	var expected = radar1[Object.keys(radar1)[0]]
	var perceive = radar1[Object.keys(radar1)[1]]
	var ownView = radar1[Object.keys(radar1)[2]]
	var data = [expected, perceive, ownView]
	RadarChart("radar1", "1", data, radarChartOptions);
});


d3.json("data/race_race.json", function(data_radar) {
    var radar_keys = Object.keys(data_radar)
    var radar1 = data_radar[radar_keys[0]]
    var expected = radar1[Object.keys(radar1)[0]]
    var perceive = radar1[Object.keys(radar1)[1]]
    var ownView = radar1[Object.keys(radar1)[2]]
    var data = [expected, perceive, ownView]
    RadarChart("radar2", "2", data, radarChartOptions);
});


function constructRadar(selectedCategory_H, selectedCategory_F, selectedGroupe_H, selectedGroupe_F){
	var category_key = str.concat(selectedCategory_H, '_', selectedCategory_F)
	var group_key = str.concat(selectedGroupe_H, '_', selectedGroupe_F)
	var expected = radar1[Object.keys(radar1)[0]]
	var perceive = radar1[Object.keys(radar1)[1]]
	var ownView = radar1[Object.keys(radar1)[2]]

	var data = [expected, perceive, ownView]
	RadarChart(".radarChart", data, radarChartOptions);
}
